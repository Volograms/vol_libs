<!DOCTYPE html>
<html>
	<!--
Example vologram web player using three.js, and the vol_geom library compiled to WASM.

First version - 2022 Dec 07 - Anton Gerdelan <anton@volograms.com> / Patrick Geoghegan <patrick@volograms.com>

HTML5 video is used for video texture and audio playback.
The requestVideoFrameCallback() extension is used for synchronous video frame fetch.
This callback is not supported on all browsers yet. https://caniuse.com/mdn-api_htmlvideoelement_requestvideoframecallback

To Run:

* Copy the vologram you want to play as a subfolder into this folder.
* Set the video source and header and sequence file to point to your vologram.
* Launch a local HTTP server from this folder.
* Open the HTML page.
* Hit "load vologram" to load and play the vologram.
-->
	<meta charset="UTF-8" />
	<meta name="author" content="Volograms Ltd." />
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

	<head> </head>

	<body>
		<input type="button" id="load_vols_files_button" value="load vologram" />
		<input type="button" id="stop_vols_files_button" value="stop vologram" />
		<canvas id="canvas"></canvas>
		<!-- playsinline stops mobile browsers fullscreen-ing the video (iOS 10+)-->
		<video controls id="texture_video_el" type="video/mp4;" width="256" height="256" loop playsinline></video>
	</body>
	<!--script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script-->

	<!-- 
    To import from the vol player from github use the following cdn template:
    `https://cdn.jsdelivr.net/gh/Volograms/vol_libs@<BRANCH_NAME>/wasm/<FILE_NAME>`
 -->
	<script src="../../wasm/vol_web.js"></script>
	<script src="../../wasm/players/VologramPlayer.js"></script>
	<script src="../../wasm/players/VologramThreeJsExtension.js"></script>
	<script src="three.js"></script>

	<script>
		// Initialise canvas for web drawing
		const canvas = document.getElementById("canvas");
		canvas.width = window.innerWidth - 50;
		canvas.height = window.innerHeight - 50;

		// Define vologram files paths
		let vologramPlayer = new VologramPlayer();
		let header_url = "../example_vologram/calif/header.vols";
		let sequence_url = "../example_vologram/calif/sequence_0.vols";
		let video_url = "../example_vologram/calif/output_720.mp4";
		let single_file_url = "../../samples/combined.vols";

		// Initialise three js rendering objects
		const scene = new THREE.Scene();
		const renderer = new THREE.WebGLRenderer({
			canvas: canvas,
		});
		renderer.setSize(canvas.clientWidth, canvas.clientHeight);
		renderer.setClearColor(new THREE.Color(147.0 / 255.0, 149.0 / 255.0, 237.0 / 255.0), 1.0);

		const camera = new THREE.PerspectiveCamera(50, canvas.clientWidth / canvas.clientHeight, 0.1, 100);
		camera.position.set(0.0, 1.2, -5.0);
		camera.lookAt(0.0, 1.2, 0.0);
		scene.add(camera);

		// Create video element that will serve has the texture for the vologram
		var video_element = document.getElementById("texture_video_el");

		// three js render function
		function render() {
			renderer.render(scene, camera);
		}

		var load_button = document.getElementById("load_vols_files_button");
		var stop_button = document.getElementById("stop_vols_files_button");

		//vologramPlayer.open(header_url, sequence_url, video_url, console.log).then(() => {
		vologramPlayer.openSingleFile(single_file_url, console.log).then(() => {
			console.log("READY TO GO");
			if (!vologramPlayer.vologram.header.singleFile) vologramPlayer.attachVideo(video_element);
			load_button.onclick = vologramPlayer.play;
			stop_button.onclick = vologramPlayer.close;
			let threeJsPlayer = new VologramThreeJsExtension(renderer, vologramPlayer);
			scene.add(vologramPlayer.vologram.three.mesh);
			renderer.setAnimationLoop(render);
		});
	</script>
</html>
